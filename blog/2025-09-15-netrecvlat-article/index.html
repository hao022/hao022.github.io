<!DOCTYPE html>
<html lang="en-us">

  <head>
    <meta charset="utf-8">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>åº”ç”¨ç¯‡ï¼šæ·±å…¥å‰–æç½‘ç»œæ”¶åŒ…å»¶è¿Ÿï¼Œä»ç½‘å¡åˆ°åº”ç”¨çš„ç²¾ç¡®è¿½è¸ªä¸ä¼˜åŒ–</title>
<meta name="author" content="HAO022" />




<meta name="keywords" content="HUATUO, BPF, å¯è§‚æµ‹æ€§, Linux å†…æ ¸, æ“ä½œç³»ç»Ÿ, æ ¹å› å®šä½, ç³»ç»Ÿæ•…éšœ, ç½‘ç»œä¼˜åŒ–, netrecvlat, containers">


<meta name="description" content="HUATUOï¼ˆåä½—ï¼‰æ˜¯ç”±æ»´æ»´å¼€æºå¹¶ä¾æ‰˜ CCF å­µåŒ–çš„äº‘åŸç”Ÿæ“ä½œç³»ç»Ÿå¯è§‚æµ‹æ€§é¡¹ç›®ï¼Œä¸“æ³¨äºä¸ºå¤æ‚äº‘åŸç”Ÿç¯å¢ƒæä¾›æ“ä½œç³»ç»Ÿå†…æ ¸çº§æ·±åº¦è§‚æµ‹èƒ½åŠ›ã€‚">

<meta name="generator" content="Hugo 0.146.4">


<link href='//fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,500,700,800' rel='stylesheet' type='text/css'>


<link rel="stylesheet" href="//use.fontawesome.com/releases/v6.7.2/css/all.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">


<link href="/css/animate.css" rel="stylesheet">



  <link href="/css/style.default.css" rel="stylesheet" id="theme-stylesheet">



<link href="/css/custom.css?1771655524" rel="stylesheet">



  <!--[if lt IE 9]>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->



<link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="/img/apple-touch-icon.png" />


<link href="/css/owl.carousel.css" rel="stylesheet">
<link href="/css/owl.theme.css" rel="stylesheet">


<link rel="alternate" href="https://huatuo.tech/index.xml" type="application/rss+xml" title="HUATUO å¼€æºæŠ€æœ¯">








<meta property="og:locale" content="en_us">
<meta property="og:site_name" content="HUATUO å¼€æºæŠ€æœ¯">
<meta property="og:title" content="åº”ç”¨ç¯‡ï¼šæ·±å…¥å‰–æç½‘ç»œæ”¶åŒ…å»¶è¿Ÿï¼Œä»ç½‘å¡åˆ°åº”ç”¨çš„ç²¾ç¡®è¿½è¸ªä¸ä¼˜åŒ–">
<meta property="og:type" content="article">
<meta property="og:url" content="https://huatuo.tech/blog/2025-09-15-netrecvlat-article/" />
<meta property="og:description" content="HUATUOï¼ˆåä½—ï¼‰æ˜¯ç”±æ»´æ»´å¼€æºå¹¶ä¾æ‰˜ CCF å­µåŒ–çš„äº‘åŸç”Ÿæ“ä½œç³»ç»Ÿå¯è§‚æµ‹æ€§é¡¹ç›®ï¼Œä¸“æ³¨äºä¸ºå¤æ‚äº‘åŸç”Ÿç¯å¢ƒæä¾›æ“ä½œç³»ç»Ÿå†…æ ¸çº§æ·±åº¦è§‚æµ‹èƒ½åŠ›ã€‚">
<meta property="og:image" content="https://huatuo.tech/img/blog/2025-09-15-net-cover.jpeg">
<meta property="og:image:type" content="image/jpeg">



  <meta property="og:image:width" content="900">
  <meta property="og:image:height" content="600">


<meta property="og:updated_time" content="2026-02-21T06:31:59Z">

  
  
  
  <meta property="article:tag" content="HUATUO">
  <meta property="article:tag" content="ç½‘ç»œä¼˜åŒ–">
  <meta property="article:tag" content="netrecvlat">
  <meta property="article:tag" content="containers">
  <meta property="article:tag" content="å¯è§‚æµ‹æ€§">
  <meta property="article:tag" content="BPF">
  
  
  <meta property="article:published_time" content="2025-09-15T07:00:00-0400">
  <meta property="article:modified_time" content="2026-02-21T06:31:59Z">



<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@GoHugoIO">
<meta name="twitter:title" content="åº”ç”¨ç¯‡ï¼šæ·±å…¥å‰–æç½‘ç»œæ”¶åŒ…å»¶è¿Ÿï¼Œä»ç½‘å¡åˆ°åº”ç”¨çš„ç²¾ç¡®è¿½è¸ªä¸ä¼˜åŒ–">

<meta name="twitter:image" content="https://huatuo.tech/img/blog/2025-09-15-net-cover.jpeg">

<meta name="twitter:description" content="HUATUOï¼ˆåä½—ï¼‰æ˜¯ç”±æ»´æ»´å¼€æºå¹¶ä¾æ‰˜ CCF å­µåŒ–çš„äº‘åŸç”Ÿæ“ä½œç³»ç»Ÿå¯è§‚æµ‹æ€§é¡¹ç›®ï¼Œä¸“æ³¨äºä¸ºå¤æ‚äº‘åŸç”Ÿç¯å¢ƒæä¾›æ“ä½œç³»ç»Ÿå†…æ ¸çº§æ·±åº¦è§‚æµ‹èƒ½åŠ›ã€‚">


    
  </head>

  <body>

    <div id="all">

        


        <header class="navbar-affixed-top" data-spy="affix" data-offset-top="62">
    <div class="navbar navbar-default yamm mouseover" role="navigation" id="navbar">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand home" href="/">
                    
                      <img src="/img/logo.png" alt="åº”ç”¨ç¯‡ï¼šæ·±å…¥å‰–æç½‘ç»œæ”¶åŒ…å»¶è¿Ÿï¼Œä»ç½‘å¡åˆ°åº”ç”¨çš„ç²¾ç¡®è¿½è¸ªä¸ä¼˜åŒ– logo" class="hidden-xs hidden-sm" />
                      <img src="/img/logo-small.png" alt="åº”ç”¨ç¯‡ï¼šæ·±å…¥å‰–æç½‘ç»œæ”¶åŒ…å»¶è¿Ÿï¼Œä»ç½‘å¡åˆ°åº”ç”¨çš„ç²¾ç¡®è¿½è¸ªä¸ä¼˜åŒ– logo" class="visible-xs visible-sm" />
                    
                    <span class="sr-only">åº”ç”¨ç¯‡ï¼šæ·±å…¥å‰–æç½‘ç»œæ”¶åŒ…å»¶è¿Ÿï¼Œä»ç½‘å¡åˆ°åº”ç”¨çš„ç²¾ç¡®è¿½è¸ªä¸ä¼˜åŒ– - è·³åˆ°ä¸»é¡µ</span>
                </a>
                <div class="navbar-buttons">
                    <button type="button" class="navbar-toggle btn-template-main" data-toggle="collapse" data-target="#navigation">
                      <span class="sr-only">åˆ‡æ¢å¯¼èˆª</span>
                        <i class="fas fa-align-justify"></i>
                    </button>
                </div>
            </div>
            

            <div class="navbar-collapse collapse" id="navigation">
                <ul class="nav navbar-nav navbar-right">
                  

                  
                  
                  

                  

                  

                  

                  
                  <li class="dropdown ">
                    
                    
                        <a href="/quickstart/">å¿«é€Ÿå¼€å§‹</a>
                    
                  </li>
                  
                  
                  
                  

                  

                  

                  

                  
                    
                    
                    <li class="dropdown ">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">æ–‡æ¡£ <span class="caret"></span></a>
                        
                        <ul class="dropdown-menu">
                            
                            <li><a href="/docs/zh/latest/">latest</a></li>
                            
                            <li><a href="/docs/zh/v2.1.0/">v2.1.0</a></li>
                            
                            <li><a href="/docs/zh/v2.0.0/">v2.0.0</a></li>
                            
                        </ul>
                        
                    </li>
                  
                  
                  
                  

                  

                  

                  

                  
                  <li class="dropdown ">
                    
                    
                        <a href="/download">ä¸‹è½½</a>
                    
                  </li>
                  
                  
                  
                  

                  

                  
                    
                  

                  

                  
                  <li class="dropdown active">
                    
                    
                        <a href="/blog/">åšå®¢</a>
                    
                  </li>
                  
                  
                  
                  

                  

                  

                  

                  
                  <li class="dropdown ">
                    
                    
                        <a href="/milestone/">åŠ¨æ€</a>
                    
                  </li>
                  
                  
                  
                  

                  

                  

                  

                  
                  <li class="dropdown ">
                    
                    
                        <a href="/about/">å…³äº</a>
                    
                  </li>
                  
                  
                  
                  

                  

                  

                  

                  
                  <li class="dropdown ">
                    
                    
                        <a href="https://github.com/ccfos/huatuo">
                            <img src="https://img.shields.io/badge/dynamic/json?label=Stars&amp;query=%24.stargazers_count&amp;url=https%3A%2F%2Fapi.github.com%2Frepos%2Fccfos%2Fhuatuo&amp;style=social&amp;logo=github&amp;formatter=none" height="100%">
                        </a>
                    
                  </li>
                  
                  
                </ul>
            </div>
            

            <div class="collapse clearfix" id="search">
                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search">
                        <span class="input-group-btn">
                    <button type="submit" class="btn btn-template-main"><i class="fas fa-search"></i></button>
                </span>
                    </div>
                </form>
            </div>
            
        </div>
    </div>
</header>




        <div id="heading-breadcrumbs">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h1>åº”ç”¨ç¯‡ï¼šæ·±å…¥å‰–æç½‘ç»œæ”¶åŒ…å»¶è¿Ÿï¼Œä»ç½‘å¡åˆ°åº”ç”¨çš„ç²¾ç¡®è¿½è¸ªä¸ä¼˜åŒ–</h1>
            </div>
        </div>
    </div>
</div>


        <div id="content">
            <div class="container">

                <div class="row">

                    

                    <div class="col-md-9" id="blog-post">

                        
                          <p class="text-muted text-uppercase mb-small text-right">
                            
                                
                                æœ€åæ›´æ–°: 2026-02-21,
			                    ä½œè€…: <a href="/authors/fanzu8">fanzu8</a>
                            
                          </p>
                        

                        <div id="post-content">
                          <h2 id="èƒŒæ™¯ä¸é—®é¢˜">èƒŒæ™¯ä¸é—®é¢˜</h2>
<p>åœ¨ç½‘ç»œæ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–ä¸­ï¼Œå…¥å‘å»¶è¿Ÿæ˜¯ä¸€ä¸ªå…³é”®æŒ‡æ ‡ã€‚ç”Ÿäº§ç¯å¢ƒä¸­é€šå¸¸é¢ä¸´å¦‚ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li>
<ol>
<li>æœ¬åœ° app æ²¡æ”¶åˆ°åŒ…ï¼Œå¯¹ç«¯å´å·²è¶…æ—¶</li>
</ol>
</li>
<li>
<ol start="2">
<li>æœ¬åœ° app æ”¶åˆ°åŒ…å´å»¶è¿Ÿï¼Œä½†ä¸ç¡®å®šå»¶è¿Ÿåœ¨å“ªä¸ªé˜¶æ®µï¼ˆå¯¹ç«¯å‘å‡ºã€é“¾è·¯å»¶è¿Ÿè¿˜æ˜¯æœ¬ä¾§ç½‘å¡ã€è°ƒåº¦ã€è½¯ä¸­æ–­ã€åè®®æ ˆã€app æ€§èƒ½ç“¶é¢ˆç­‰ï¼‰</li>
</ol>
</li>
</ul>
<p>æœ¬æ–‡è®¨è®ºé—®é¢˜ 2 ä¸­ï¼Œä»æœ¬æœºç½‘å¡åˆ° app ä¸»åŠ¨æ”¶å–åŒ…è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å­˜åœ¨çš„å»¶è¿Ÿç‚¹ã€‚</p>
<p><img src="/img/blog/2025-09-15-netrecvlat-illustration1.png" alt="æ”¶æ–¹å‘è€—æ—¶ç¤ºæ„1"></p>
<p>ç†æƒ³çŠ¶æ€æˆ‘ä»¬å¸Œæœ›ä»ç½‘çº¿æœ«ç«¯å°±æ‹¿åˆ°æŠ¥æ–‡çš„æ—¶é—´æˆ³ <code>t_ideal0</code> ä½œä¸ºæŠ¥æ–‡åˆ°è¾¾æœ¬æœºçš„æ—¶é—´ç‚¹ï¼Œç”¨æˆ·æ€ä¸»åŠ¨å–èµ°æŠ¥æ–‡çš„æ—¶é—´ä½œä¸º <code>t_user</code>ï¼Œè¿™æ · <code>t_user - t_ideal0</code> å°±æ˜¯æœ¬æœºæ”¶å–æŠ¥æ–‡çš„å®Œæ•´è€—æ—¶ã€‚æ˜¾ç„¶å¯¹äº <code>t_ideal0</code> çš„è·å–æ˜¯ä¸å¯èƒ½çš„ï¼Œé‚£ä¹ˆè‡³å°‘è¦åœ¨ç½‘å¡å›ºä»¶æˆ–è€…é©±åŠ¨ç”šè‡³æ›´ä¸Šå±‚è·å–ä¸ª <code>t_ideal1</code> åº”è¯¥ä¸è¿‡åˆ†ï¼Œ<code>delta = t_ideal1 - t_ideal0</code>ï¼Œå› æ­¤æœ¬æœºæ”¶åˆ°æŠ¥æ–‡çš„åˆå§‹æ—¶é—´è·å–é—®é¢˜è½¬æ¢ä¸ºå¦‚ä½•ä½¿ <code>delta</code> å°½å¯èƒ½å°ï¼Œä¹Ÿå°±æ˜¯è¯´<strong>åœ¨å°½é‡é è¿‘ç½‘å¡çš„ä½ç½®æ‰¾ä¸€ä¸ªèƒ½æ‰“æ—¶é—´æˆ³çš„ç‚¹</strong>ã€‚</p>
<p>çœ‹ä¸‹ç½‘å¡ä¾§çš„æ‰“æ—¶é—´æˆ³çš„ Capabilitiesï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ethtool -T eth0 <span style="color:#75715e"># -T  Show time stamping capabilities</span>
</span></span><span style="display:flex;"><span>Time stamping parameters <span style="color:#66d9ef">for</span> eth0:
</span></span><span style="display:flex;"><span>Capabilities:
</span></span><span style="display:flex;"><span>	hardware-transmit     <span style="color:#f92672">(</span>SOF_TIMESTAMPING_TX_HARDWARE<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	hardware-receive      <span style="color:#f92672">(</span>SOF_TIMESTAMPING_RX_HARDWARE<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	hardware-raw-clock    <span style="color:#f92672">(</span>SOF_TIMESTAMPING_RAW_HARDWARE<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>PTP Hardware Clock: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Hardware Transmit Timestamp Modes:
</span></span><span style="display:flex;"><span>	off                   <span style="color:#f92672">(</span>HWTSTAMP_TX_OFF<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	on                    <span style="color:#f92672">(</span>HWTSTAMP_TX_ON<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Hardware Receive Filter Modes:
</span></span><span style="display:flex;"><span>	none                  <span style="color:#f92672">(</span>HWTSTAMP_FILTER_NONE<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	all                   <span style="color:#f92672">(</span>HWTSTAMP_FILTER_ALL<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>å†…æ ¸æä¾›é€šè¿‡ç³»ç»Ÿè°ƒç”¨ <code>setsockopt</code> å¼€å¯æŠ¥æ–‡è‡ªåŠ¨æ‰“ä¸Šæ—¶é—´æˆ³çš„é€‰é¡¹ <code>SO_TIMESTAMPING</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>err <span style="color:#f92672">=</span> <span style="color:#a6e22e">setsockopt</span>(fd, SOL_SOCKET, SO_TIMESTAMPING, <span style="color:#f92672">&amp;</span>val, <span style="color:#66d9ef">sizeof</span>(val));
</span></span></code></pre></div><p>å†çœ‹ä¸‹ç”¨æˆ·ä¾§å¦‚ä½•ä»æŠ¥æ–‡ä¸­è·å–æ—¶é—´æˆ³ï¼Œ å†…æ ¸é€šè¿‡ <code>cmsg</code> æŠŠæŠ¥æ–‡çš„æ—¶é—´æˆ³ä¿¡æ¯è¿”å›ä¸Šå±‚ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *	struct scm_timestamping - timestamps exposed through cmsg
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *	The timestamping interfaces SO_TIMESTAMPING, MSG_TSTAMP_*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *	communicate network timestamps by passing this struct in a cmsg with
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *	recvmsg(). See Documentation/networking/timestamping.txt for details.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> scm_timestamping {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> timespec ts[<span style="color:#ae81ff">3</span>];
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>å…¶ä¸­è¿˜åŒ…æ‹¬äº†åº•å±‚ç¡¬ä»¶è®°å½•çš„æ—¶é—´æˆ³ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">tcp_update_recv_tstamps</span>(<span style="color:#66d9ef">struct</span> sk_buff <span style="color:#f92672">*</span>skb,
</span></span><span style="display:flex;"><span>				    <span style="color:#66d9ef">struct</span> scm_timestamping <span style="color:#f92672">*</span>tss)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (skb<span style="color:#f92672">-&gt;</span>tstamp)
</span></span><span style="display:flex;"><span>		tss<span style="color:#f92672">-&gt;</span>ts[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ktime_to_timespec</span>(skb<span style="color:#f92672">-&gt;</span>tstamp);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>		tss<span style="color:#f92672">-&gt;</span>ts[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> timespec) {<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">skb_hwtstamps</span>(skb)<span style="color:#f92672">-&gt;</span>hwtstamp)
</span></span><span style="display:flex;"><span>		tss<span style="color:#f92672">-&gt;</span>ts[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ktime_to_timespec</span>(<span style="color:#a6e22e">skb_hwtstamps</span>(skb)<span style="color:#f92672">-&gt;</span>hwtstamp);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>		tss<span style="color:#f92672">-&gt;</span>ts[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> timespec) {<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æˆ‘ä»¬èƒ½ä¸èƒ½åˆ©ç”¨è¿™ä¸ªæ—¶é—´æˆ³å°†ç½‘ç»œæŠ¥æ–‡æ”¶æ–¹å‘çš„å»¶è¿Ÿåšåˆ°åˆ†é˜¶æ®µè®¡ç®—å¹¶é€šç”¨åŒ–å‘¢ï¼Ÿç»§ç»­å¾€ä¸‹åˆ†æã€‚</p>
<h2 id="æ—¶é—´æˆ³å­˜æ”¾ä½ç½®">æ—¶é—´æˆ³å­˜æ”¾ä½ç½®</h2>
<p>æ—¶é—´æˆ³åœ¨ skb ä¸­çš„å­˜æ”¾ä½ç½®æœ‰ä¸¤ä¸ªåœ°æ–¹:</p>
<ul>
<li>
<p>skb-&gt;tstamp åœ¨ <code>sk_buff</code> çš„ <code>union</code> é‡Œï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> sk_buff {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">union</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">ktime_t</span>		tstamp;
</span></span><span style="display:flex;"><span>        u64		skb_mstamp;
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>åº•å±‚ç¡¬ä»¶æ—¶é—´æˆ³å­˜æ”¾åœ¨ <code>sk_buff</code> çš„ <code>skb_shared_info</code> ç»“æ„ä¸­ï¼Œé€šè¿‡  <code>skb_hwstamps(skb)-&gt;hwstamp</code> å¾—åˆ°å…¶æŒ‡é’ˆï¼Œç„¶åè¯»å–æˆ–ä¿®æ”¹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#define skb_shinfo(SKB)	((struct skb_shared_info *)(skb_end_pointer(SKB)))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>...
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">struct</span> skb_shared_hwtstamps <span style="color:#f92672">*</span><span style="color:#a6e22e">skb_hwtstamps</span>(<span style="color:#66d9ef">struct</span> sk_buff <span style="color:#f92672">*</span>skb)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">skb_shinfo</span>(skb)<span style="color:#f92672">-&gt;</span>hwtstamps;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> skb_shared_hwtstamps {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">ktime_t</span>	hwtstamp;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div></li>
</ul>
<h2 id="ç¡¬ä»¶æ—¶é—´æˆ³">ç¡¬ä»¶æ—¶é—´æˆ³</h2>
<p>ç¡¬ä»¶æ—¶é—´æˆ³ç”±ç½‘å¡é©±åŠ¨å®ç°çš„ napi çš„ <code>poll</code> æ¥å£æä¾›ï¼Œè¿™é‡Œç»™å‡º mlx å’Œ ixgbe çš„éƒ¨åˆ†é©±åŠ¨ä»£ç è°ƒç”¨å…³ç³»ä½œå‚è€ƒï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>mlx5: <span style="color:#a6e22e">netif_napi_add</span>(netdev, <span style="color:#f92672">&amp;</span>c<span style="color:#f92672">-&gt;</span>napi, mlx5e_napi_poll, <span style="color:#ae81ff">64</span>);
</span></span><span style="display:flex;"><span>mlx5e_napi_poll
</span></span><span style="display:flex;"><span>    mlx5e_poll_rx_cq
</span></span><span style="display:flex;"><span>        mlx5e_handle_rx_cqe
</span></span><span style="display:flex;"><span>            mlx5e_complete_rx_cqe
</span></span><span style="display:flex;"><span>                mlx5e_build_rx_skb
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">skb_hwtstamps</span>(skb)<span style="color:#f92672">-&gt;</span>hwtstamp <span style="color:#f92672">=</span><span style="color:#a6e22e">mlx5_timecounter_cyc2time</span>(rq<span style="color:#f92672">-&gt;</span>clock, <span style="color:#a6e22e">get_cqe_ts</span>(cqe));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ixgbe: <span style="color:#a6e22e">netif_napi_add</span>(adapter<span style="color:#f92672">-&gt;</span>netdev, <span style="color:#f92672">&amp;</span>q_vector<span style="color:#f92672">-&gt;</span>napi, ixgbe_poll, <span style="color:#ae81ff">64</span>);
</span></span><span style="display:flex;"><span>ixgbe_poll
</span></span><span style="display:flex;"><span>    ixgbe_clean_rx_irq
</span></span><span style="display:flex;"><span>        ixgbe_process_skb_fields
</span></span><span style="display:flex;"><span>            ixgbe_ptp_rx_hwtstamp
</span></span><span style="display:flex;"><span>                ixgbe_ptp_rx_rgtstamp
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">ixgbe_ptp_convert_to_hwtstamp</span>(adapter, <span style="color:#a6e22e">skb_hwtstamps</span>(skb), regval);
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">skb_hwtstamps</span>(skb)
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ° mlx å’Œ ixgbe æ‰“ç¡¬ä»¶æ—¶é—´æˆ³çš„æ–¹å¼æœ‰æ‰€ä¸åŒï¼Œå…¶ä¸­ ixgbe è¿˜ä¾èµ– PTP(Precision Time
Protocol) æ–¹å¼å»ç”Ÿæˆç¡¬ä»¶æ—¶é—´æˆ³ã€‚</p>
<p>éªŒè¯çœ‹çœ‹å¼€å¯ç¡¬ä»¶æ—¶é—´æˆ³åæ”¶åˆ°çš„æ•°æ®é•¿ä»€ä¹ˆæ ·ï¼Œå¼€å¯ç½‘å¡æ”¶åŒ…æ—¶é—´æˆ³ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ hwstamp_ctl -r <span style="color:#ae81ff">1</span> -i eth0 <span style="color:#75715e"># -r [0..14]   select receive time stamping: 1 time stamp any incoming packet</span>
</span></span><span style="display:flex;"><span>current settings:
</span></span><span style="display:flex;"><span>tx_type <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>rx_filter <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>new settings:
</span></span><span style="display:flex;"><span>tx_type <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>rx_filter <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>ç¡¬ä»¶æ—¶é—´æˆ³å­˜æ”¾åœ¨ <code>sk_buff</code> çš„ <code>skb_shared_info</code> ç»“æ„ä¸­ï¼Œé€šè¿‡  <code>skb_hwstamps(skb)-&gt;hwstamp</code> è·å–å…¶æŒ‡é’ˆï¼Œ bpftrace å·¥å…·ä¸­å°†å‡½æ•°å±‚å±‚å±•å¼€å¦‚ä¸‹ï¼Œ
åœ¨ç‚¹ <code>netif_receive_skb</code> ç”¨ bpftrace å·¥å…·éªŒè¯ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ bpftrace -e <span style="color:#e6db74">&#39;tracepoint:net:netif_receive_skb {$skb = (struct sk_buff *)args-&gt;skbaddr; printf(&#34;%llx\n&#34;, ((struct skb_shared_info *)($skb-&gt;head + $skb-&gt;end))-&gt;hwtstamps.hwtstamp);}&#39;</span>
</span></span><span style="display:flex;"><span>// å¼€å¯å‰
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// å¼€å¯å
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1698221031030014635</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1698221056659251659</span>
</span></span></code></pre></div><p>éœ€è¦æ³¨æ„çš„æ˜¯åœ¨é©±åŠ¨å±‚æ‰“æ—¶é—´æˆ³çš„æ–¹æ³• <code>timecounter_cyc2time()</code> æˆ–è€… <code>ixgbe_ptp_convert_to_hwtstamp</code> ä¸ä¸Šå±‚è·å–åˆ°çš„å†…æ ¸æä¾›çš„å¢™ä¸Šæ—¶é’Ÿæ—¶é—´æˆ³çš„ <code>ktime_get_real()</code> å­˜åœ¨åå·®ï¼Œæœ¬åœ°æµ‹è¯•å‘ç°å…¶åå·®éšæ—¶é—´æ¨ç§»é€æ¸å˜åŒ–ï¼Œä¸æ˜¯ç®€å•çš„çº¿æ€§å…³ç³»ï¼Œæ¶‰åŠ ptp ä¸»ä»æ—¶é—´åŒæ­¥ï¼Œåœ¨ç”¨ <code>linuxptp</code> åŒæ­¥ä¹‹åæ˜æ˜¾åå·®å‡å°ä½†ä¾ç„¶å­˜åœ¨ï¼Œè¿™ä¸é©±åŠ¨ä»ç½‘å¡ phc è·å–æ—¶é—´çš„å…·ä½“å®ç°æœ‰å…³ï¼Œéœ€è¦ææ¸… phcã€ptp è¿™ä¸€å—ä¸åŒé©±åŠ¨çš„å®ç°æ‰èƒ½æ›´å¥½çš„åˆ©ç”¨ç¡¬ä»¶æ—¶é—´æˆ³ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥å®šæœŸè¯»å– phc çš„æ—¶é—´æˆ³ä¸ç³»ç»Ÿæ—¶é—´æˆ³è®¡ç®— offset ä½œä¸ºå‚è€ƒå€¼ã€‚phc æ—¶é—´æˆ³è·å–å¯é€šè¿‡ SYS_CLOCK_GETTIME å®ç°ï¼Œoffset çš„ä¼°è®¡å€¼è®¡ç®—æ–¹æ³•å‚è€ƒï¼š <a href="https://github.com/facebook/time/blob/main/phc/offset.go#L83">https://github.com/facebook/time/blob/main/phc/offset.go#L83</a>ï¼Œ
å› æ­¤æƒ³é€šè¿‡åœ¨æœ€é è¿‘ç½‘çº¿çš„ç½‘å¡å±‚è·å–æŠ¥æ–‡åˆ°è¾¾æœ¬æœºçš„åˆå§‹æ—¶é—´æ²¡é‚£ä¹ˆç®€å•ã€‚</p>
<h2 id="è½¯ä»¶æ—¶é—´æˆ³">è½¯ä»¶æ—¶é—´æˆ³</h2>
<p>å†å¾€ä¸Šä¸€å±‚æ‰¾ï¼Œå¥½åƒé™¤äº†å†…æ ¸åè®®æ ˆæ”¶åŒ…å…¥å£å‡½æ•° <code>netif_receive_skb</code> å†æ²¡æœ‰ä¸€ä¸ªè·ç¦»ç½‘å¡æ›´è¿‘ä¸€ç‚¹çš„ä¸€ä¸ªç»Ÿä¸€å…¥å£äº†ã€‚å¯¹ä»£ç è¿›è¡Œæ¢³ç†ç„¶åé€ä¸ªåˆ†ææ˜¯å¦å­˜åœ¨ <code>netif_receive_skb</code> è°ƒç”¨å‰è¿˜æœ‰æ‰“æ—¶é—´æˆ³çš„åœ°æ–¹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">é</span> NAPI: 
</span></span><span style="display:flex;"><span>netif_rx
</span></span><span style="display:flex;"><span>    netif_rx_internal
</span></span><span style="display:flex;"><span>        enqueue_to_backlog
</span></span><span style="display:flex;"><span>            softnet_data.input_pkt_queue <span style="color:#f92672">-&gt;</span> backlog <span style="color:#f92672">-&gt;</span> softnet_data.poll_list
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">è½¯ä¸­æ–­</span>
</span></span><span style="display:flex;"><span>            net_rx_action
</span></span><span style="display:flex;"><span>                process_backlog
</span></span><span style="display:flex;"><span>                    __netif_receive_skb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAPI:
</span></span><span style="display:flex;"><span>IRQ
</span></span><span style="display:flex;"><span>    napi_schedule
</span></span><span style="display:flex;"><span>        softnet_data.poll_list
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">è½¯ä¸­æ–­</span>
</span></span><span style="display:flex;"><span>        poll
</span></span><span style="display:flex;"><span>            napi_gro_receive
</span></span><span style="display:flex;"><span>                netif_receive_skb_internal
</span></span><span style="display:flex;"><span>                    __netif_receive_skb
</span></span></code></pre></div><p>å‘ç°æ— è®ºæ˜¯èµ° napi è¿˜æ˜¯ä¸èµ° napi çš„è·¯å¾„éƒ½æœ‰åœ¨ä¸Šé€åè®®æ ˆå‰æ‰“æ—¶é—´æˆ³çš„åœ°æ–¹ï¼Œçœ‹æ¥æ˜¯æœ‰å¸Œæœ›ï¼š</p>
<ul>
<li>
<p>ä¸èµ° napi</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>netif_rx_internal
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">net_timestamp_check</span>(netdev_tstamp_prequeue, skb); <span style="color:#f92672">&lt;--</span>
</span></span><span style="display:flex;"><span>    enqueue_to_backlog
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div></li>
<li>
<p>èµ° napi</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>netif_receive_skb_internal
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">net_timestamp_check</span>(netdev_tstamp_prequeue, skb); <span style="color:#f92672">&lt;--</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div></li>
</ul>
<p>å…¶ä¸­ <code>net_timestamp_check</code> ç›¸å…³å®ç°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#define net_timestamp_check(COND, SKB)				\
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	if (static_branch_unlikely(&amp;netstamp_needed_key)) {	\
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		if ((COND) &amp;&amp; !(SKB)-&gt;tstamp)			\
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">			__net_timestamp(SKB);			\
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	}							\
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__net_timestamp</span>(<span style="color:#66d9ef">struct</span> sk_buff <span style="color:#f92672">*</span>skb)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	skb<span style="color:#f92672">-&gt;</span>tstamp <span style="color:#f92672">=</span> <span style="color:#a6e22e">ktime_get_real</span>(); <span style="color:#f92672">&lt;--</span> <span style="color:#960050;background-color:#1e0010">å†…æ ¸æ‰“å°çš„æ—¶é—´æˆ³ï¼ˆ</span>wall time<span style="color:#960050;background-color:#1e0010">ï¼‰</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sysctl -a |grep netdev_tstamp_prequeue
</span></span><span style="display:flex;"><span>net.core.netdev_tstamp_prequeue <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> &lt;-- å†³å®šæ‰“æ—¶é—´æˆ³ä½ç½®åœ¨ RPS å‰
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¦‚ä½•å¼€å¯æ‰“æ­¤æ—¶é—´æˆ³çš„åŠŸèƒ½å¯å‚è€ƒ HUATUO ä»£ç </span>
</span></span></code></pre></div><p>ä½†æ˜¯è¿™æ ·ï¼Œä»ä¸Šé¢è°ƒç”¨è·¯å¾„çš„è§£æå¯ä»¥æ¸…æ¥šçœ‹åˆ°å¯¹äºèµ° NAPI çš„è·¯å¾„çš„æŠ¥æ–‡å°±æ²¡åŠæ³•è¦†ç›–è½¯ä¸­æ–­çš„å»¶è¿Ÿäº†ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ª delta ç¨å¾®å¤§äº†ä¸€ç‚¹ç‚¹ï¼Œä¸è¿‡ä¹Ÿè¿˜è¡Œï¼Œä¹Ÿè¿˜èƒ½ç”¨ï¼Œè¿™æ ·æŠ¥æ–‡åˆ°è¾¾æœ¬æœºçš„åˆå§‹æ—¶é—´æˆ³ ts0 å°±å·®ä¸å¤šè§£å†³äº†ã€‚</p>
<h2 id="è®¡ç®—å»¶è¿Ÿ">è®¡ç®—å»¶è¿Ÿ</h2>
<p><img src="/img/blog/2025-09-15-netrecvlat-illustration2.png" alt="æ”¶æ–¹å‘è€—æ—¶ç¤ºæ„2"></p>
<ul>
<li>
<p><strong>åè®®æ ˆå…¥å£</strong></p>
<p>å‰é¢æœ‰æåˆ° <code>netif_receive_skb</code> ä¸ºåè®®æ ˆç»Ÿä¸€å…¥å£å‡½æ•°ï¼Œå†…æ ¸ä¹Ÿæœ‰ tracepoint ç‚¹ï¼Œåœ¨è¿™é‡Œè·å–æ—¶é—´æˆ³ <code>ts1</code> ä½œä¸ºè¿‘ä¼¼è®¡ç®—é©±åŠ¨ã€è½¯ä¸­æ–­çš„å»¶è¿Ÿã€‚</p>
</li>
<li>
<p><strong>åè®®æ ˆå‡ºå£</strong></p>
<p>è¿›å…¥åè®®æ ˆåï¼ŒæŠ¥æ–‡åˆ°è¾¾ <code>tcp_v4_rcv</code> å¯è®¤ä¸ºåè®®å±‚å¤„ç†å®Œæ¯•ï¼Œå› æ­¤åœ¨  <code>tcp_v4_rcv</code> å¤„è·å–æ—¶é—´æˆ³ <code>ts2</code> ä½œä¸ºè®¡ç®—åè®®æ ˆçš„å»¶è¿Ÿçš„åŸºç¡€ã€‚</p>
</li>
<li>
<p><strong>ç”¨æˆ·ä¸»åŠ¨å–åŒ…</strong></p>
<p>æ¥ä¸‹æ¥æ˜¯ç”¨æˆ·è¿›ç¨‹ä¸»åŠ¨è°ƒç”¨åˆ° <code>tcp_recvmsg</code> ä» skb å°†æ•°æ®æ‹·è´åˆ° socket ç¼“å†²åŒº, ç»¼åˆæ€§èƒ½æŸè€—å’Œæ˜¯å¦é€šç”¨ä¸”æ˜¯å¦æ˜“äºå®ç°ï¼Œè¿™é‡Œé€‰å– <code>skb_copy_datagram_iovec</code> ç‚¹ä½œä¸ºç”¨æˆ·æ”¶åŒ…çš„æ—¶é—´ç‚¹ <code>ts3</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*	skb_copy_datagram_iter - Copy a datagram to an iovec iterator.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*	@skb: buffer to copy
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*	@offset: offset in the buffer to start copying from
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*	@to: iovec iterator to copy to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*	@len: amount of data to copy from buffer to iovec
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">skb_copy_datagram_iter</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> sk_buff <span style="color:#f92672">*</span>skb, <span style="color:#66d9ef">int</span> offset,
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">struct</span> iov_iter <span style="color:#f92672">*</span>to, <span style="color:#66d9ef">int</span> len)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">trace_skb_copy_datagram_iovec</span>(skb, len);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">__skb_datagram_iter</span>(skb, offset, to, len, false,
</span></span><span style="display:flex;"><span>            simple_copy_to_iter, NULL);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<p><strong>å°ç»“ä¸€ä¸‹ï¼š</strong></p>
<ul>
<li>è¿‘ä¼¼è®¡ç®—é©±åŠ¨ã€è½¯ä¸­æ–­çš„å»¶è¿Ÿ: <code>ts1 - ts0</code></li>
<li>åè®®æ ˆå»¶è¿Ÿï¼š<code>ts2 - ts1</code></li>
<li>ç”¨æˆ·ä¸»åŠ¨å–åŒ…å»¶è¿Ÿï¼š<code>ts3 - ts2</code></li>
</ul>
<p>ç”±å‰é¢å¯çŸ¥ï¼Œ<code>ts0</code> æ˜¯å†…æ ¸å‡½æ•° <code>ktime_get_real</code> ç”Ÿæˆçš„è½¯ä»¶çš„æ—¶é—´æˆ³ï¼Œ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * ktime_get_real - get the real (wall-) time in ktime_t format
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">ktime_t</span> <span style="color:#a6e22e">ktime_get_real</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ktime_get_with_offset</span>(TK_OFFS_REAL);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å…¶æ ¼å¼ä¸º <code>SKB_CLOCK_REALTIME</code> å¢™ä¸Šæ—¶é’Ÿã€‚ä¸ºäº†åšåˆ°æ— ä¾µå…¥æ›´é€šç”¨åŒ–ï¼Œ<code>ts1/2/3</code> çš„è·å–å¯ç”± bpf å®ç°ï¼Œåœ¨ <a href="https://github.com/torvalds/linux/commit/c8996c98f703b09afe77a1d247dae691c9849dc1">kernel v6.1</a> å‰ bpf helper é‡Œåªæä¾›äº† <code>bpf_ktime_get_ns</code> å…¶æ ¼å¼ä¸º <code>SKB_CLOCK_MONOTONIC</code>ï¼Œä¸¤ç§æ—¶é—´æˆ³æ ¼å¼çš„åç§»ä¼°ç®—ä»¥åŠä¸Šè¿°ä¸‰ä¸ªé˜¶æ®µçš„å»¶è¿Ÿè®¡ç®—æ–¹æ³•è¯¦æƒ…å¯å‚è€ƒ HUATUO ä»£ç ã€‚</p>
<p><strong>æ€»ç»“ï¼š</strong></p>
<p>ä»¥ä¸Šå°±æ˜¯ HUATUO ç½‘ç»œæ”¶åŒ…å»¶è¿Ÿ netrecvlat æ–¹æ¡ˆçš„æ ¸å¿ƒé€»è¾‘ï¼Œå¯ä»¥çœ‹åˆ°æ­¤æ”¶æ–¹å‘å»¶è¿Ÿäº‹ä»¶æ–¹æ¡ˆå¹¶æ²¡æœ‰æŠŠæ£€æµ‹ç²’åº¦ç»†åŒ–åˆ°ç½‘å¡é©±åŠ¨ã€vlan è½¬å‘ã€RPS ç­‰ç¯èŠ‚çš„è€—æ—¶ï¼Œé™¤äº†è€ƒè™‘åˆ°æ€§èƒ½æ¶ˆè€—å’Œå®ç°å­˜åœ¨ä¸€å®šçš„éš¾åº¦å¤–ï¼Œè¿˜è€ƒè™‘åˆ°ç›®å‰æ–¹æ¡ˆåœ¨è§£å†³é€šç”¨é—®é¢˜ä¹Ÿå®Œå…¨å¤Ÿç”¨ã€‚</p>
<h2 id="åº”ç”¨">åº”ç”¨</h2>
<ul>
<li>
<p><strong>è½¯ä¸­æ–­ä¼˜åŒ–</strong></p>
<p>loopback æ¥å£ä¼šåœ¨ <code>loopback_xmit</code> ä¸­å°†æ—¶é—´æˆ³æ¸…é›¶ï¼Œnetrecvlat èƒ½è®¡ç®—ä½¿ç”¨ loopback æ¥å£ï¼ˆèµ°é napi è·¯å¾„ï¼‰é€šä¿¡çš„æŠ¥æ–‡åœ¨è½¯ä¸­æ–­ä¸­çš„å»¶è¿Ÿï¼Œå› æ­¤å¯é€šè¿‡å¯¹ loopback å‘å‹å¾—åˆ°åŒ…å«è½¯ä¸­æ–­å»¶è¿Ÿ(<code>ts1 - ts0</code>) çš„æ•°æ®ï¼Œç„¶åå‚è€ƒè¯¥æ•°æ®å¯¹è½¯ä¸­æ–­åšç›¸å…³ä¼˜åŒ–ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯è½¯ä¸­æ–­æ˜¯é’ˆå¯¹ç³»ç»Ÿå…¨å±€çš„æœºåˆ¶ï¼Œé€šå¸¸ä¼˜åŒ–è½¯ä¸­æ–­åœ¨ä¸šåŠ¡æŒ‡æ ‡ä¸Šæ²¡æœ‰ç›´æ¥çš„æ•ˆæœï¼Œä¸ä¼šå¸¦æ¥èƒ½ç«‹åˆ»çœ‹åˆ°çš„æ˜æ˜¾ä¸šåŠ¡æ”¶ç›Šï¼Œæ›´å¤šçš„æ˜¯è¡¨ç°åœ¨ä¸šåŠ¡æŒ‡æ ‡çš„é•¿å°¾ä¼˜åŒ–ã€‚</p>
<p>è½¯ä¸­æ–­ä¼˜åŒ–å‰å netrecvlat äº‹ä»¶æ•°é‡å¯¹æ¯”
<img src="/img/blog/2025-09-15-netrecvlat-softirq-optimize.png" alt="è½¯ä¸­æ–­ä¼˜åŒ–äº‹ä»¶å¯¹æ¯”"></p>
<p>ä¸šåŠ¡é•¿å°¾ä¼˜åŒ–æ•ˆæœ
<img src="/img/blog/2025-09-15-netrecvlat-app-latency-optimize.png" alt="ä¸šåŠ¡é•¿å°¾å»¶è¿Ÿä¼˜åŒ–"></p>
</li>
<li>
<p><strong>é—®é¢˜å®šç•Œ</strong></p>
<p>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ˜ç¡® â€œé—®é¢˜è¾¹ç•Œâ€ é€šå¸¸é¢ä¸´ä¸¤å¤§æŒ‘æˆ˜ï¼Œæˆ‘å¯¹ â€œé—®é¢˜è¾¹ç•Œâ€ æœ‰ä»¥ä¸‹ä¸¤ä¸ªç»´åº¦çš„ç†è§£ï¼š</p>
<ul>
<li>å®šä½æ–¹å‘ï¼šç›´æ¥å½±å“æ ¹å› å®šä½çš„æ—¶æ•ˆä¸æ­¢æŸç­–ç•¥çš„åˆ¶å®šï¼Œæ˜ç¡®çš„å®šä½æ–¹å‘èƒ½å¤Ÿæ˜¾è‘—æå‡æ•…éšœæ’æŸ¥æ•ˆç‡ï¼ˆ<em>æŠ“æ‰‹</em>ğŸ¤©ï¼‰</li>
<li>è´£ä»»åˆ’åˆ†ï¼šç¡®å®šé—®é¢˜å‡ºç°çš„å…·ä½“ç¯èŠ‚ä¸å¯¹åº”è´£ä»»äººï¼ˆ<em>åˆ†é”…</em>ğŸ¤©ï¼‰</li>
</ul>
<p>ç”¨æˆ·ä¸»åŠ¨ä»å†…æ ¸å–åŒ…çš„æ—¶é—´ç‚¹ <code>ts3</code> å¯ä»¥å°†å»¶è¿Ÿé—®é¢˜åˆ’åˆ†åˆ°ç”¨æˆ·ä¾§è¿˜æ˜¯å†…æ ¸ä¾§ï¼›å¦‚æœèƒ½æŠŠç¡¬ä»¶æ—¶é—´æˆ³æ‹¿åˆ°ï¼Œ<code>ts1</code>, <code>ts2</code> èƒ½å°†å»¶è¿Ÿé”å®šåˆ°æ˜¯åœ¨é©±åŠ¨ã€è½¯ä¸­æ–­è¿˜æ˜¯åè®®æ ˆã€‚</p>
<p><img src="/img/blog/2025-09-15-netrecvlat-dashbroad-demo.png" alt="æ”¶ç½‘ç»œæŠ¥å»¶è¿Ÿ-å¤§ç›˜demo"></p>
</li>
</ul>
<h2 id="å¯èƒ½å­˜åœ¨çš„é—®é¢˜ä»¥åŠä¼˜åŒ–ç‚¹">å¯èƒ½å­˜åœ¨çš„é—®é¢˜ä»¥åŠä¼˜åŒ–ç‚¹</h2>
<ul>
<li><code>ts0</code> è€ƒè™‘æ›´ç¨³å®šå‡†ç¡®çš„ç¡¬ä»¶æ—¶é—´æˆ³ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å¢åŠ èµ° NAPI è·¯å¾„çš„æŠ¥æ–‡åŒ…å«è½¯ä¸­æ–­çš„å»¶è¿Ÿæ£€æµ‹</li>
<li>å½“å‰ä½¿ç”¨å¢™ä¸Šæ—¶é’Ÿï¼Œè·³å˜/å›æ‹¨å¦‚ä½•å¤„ç†ï¼Ÿ</li>
<li>é«˜ç‰ˆæœ¬å†…æ ¸å¯¹ skb æ—¶é—´æˆ³çš„å¤„ç†å¼•å…¥äº† <a href="https://github.com/torvalds/linux/blob/4d25ca2d6801cfcf26f7f39c561611ba5be99bf8/include/linux/skbuff.h#L960">tstamp_type</a> æ˜¯å¦å¯æ ¹æ®ä¸åŒåº”ç”¨åœºæ™¯è®¾ç½®ä¸åŒç±»å‹çš„æ—¶é—´å€¼</li>
<li>æŠ¥æ–‡åˆ†æ‰¹æ‹·è´åˆ°ç”¨æˆ·æ¥æ”¶ç¼“å†²åŒºçš„å»¶è¿Ÿäº‹ä»¶å¯èƒ½å­˜åœ¨é‡å¤ï¼ˆè€ƒè™‘äº”å…ƒç»„ æˆ– skb åœ°å€å»é‡ï¼Ÿï¼‰</li>
<li>ipv6 æ”¯æŒ</li>
<li>é˜ˆå€¼è®¾ç½®ç²’åº¦æ›´ç»†ï¼ˆè€ƒè™‘ qosã€å»¶è¿Ÿæ•æ„Ÿä¸šåŠ¡ç­‰ï¼‰</li>
<li>kernel v5.18 å¼•å…¥ <a href="https://github.com/torvalds/linux/commit/9bb984f28d5bcb917d35d930fcfb89f90f9449fd">bpf_skb_set_tstamp()</a>ï¼Œæ˜¯å¦ä¼šå¯¼è‡´é˜ˆå€¼å¤±æ•ˆï¼Œå¦‚ä½•åŒºåˆ†ï¼Ÿ</li>
</ul>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="https://github.com/torvalds/linux/blob/v5.10/Documentation/networking/timestamping.rst">https://github.com/torvalds/linux/blob/v5.10/Documentation/networking/timestamping.rst</a></li>
<li><a href="https://github.com/facebook/time">https://github.com/facebook/time</a></li>
<li><a href="https://docs.ebpf.io/linux/helper-function/bpf_skb_set_tstamp/">https://docs.ebpf.io/linux/helper-function/bpf_skb_set_tstamp/</a></li>
<li><a href="https://bootlin.com/pub/conferences/2020/elce/tenart-timestamping-and-ptp-in-linux/tenart-timestamping-and-ptp-in-linux.pdf">https://bootlin.com/pub/conferences/2020/elce/tenart-timestamping-and-ptp-in-linux/tenart-timestamping-and-ptp-in-linux.pdf</a></li>
</ul>

                        </div>

                        
                        
                        
                        <div id="comments"><script src="https://giscus.app/client.js"
        data-repo="hao022/huatuo-website-comments"
        data-repo-id="R_kgDOPfpsuA"
        data-category="Announcements"
        data-category-id="DIC_kwDOPfpsuM4CuSXS"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="zh-CN"
        crossorigin="anonymous"
        async>
</script>
</div>
                        

                    </div>
                    

                    

                    

                    <div class="col-md-3">

                        

                        

<div class="panel panel-default sidebar-menu">

    <div class="panel-heading">
      <h3 class="panel-title">æœç´¢</h3>
    </div>

    <div class="panel-body">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" role="search">
            <div class="input-group">
                <input type="search" name="q" class="form-control" placeholder="æœç´¢" />
                <input type="hidden" name="sitesearch" value="https://huatuo.tech/" />
                <span class="input-group-btn">
                    <button type="submit" class="btn btn-template-main"><i class="fas fa-search"></i></button>
                </span>
            </div>
        </form>
    </div>
</div>














<div class="panel sidebar-menu">

    <div class="panel-heading">
        <h3 class="panel-title">æ ‡ç­¾</h3>
    </div>

    <div class="panel-body">
        <ul class="tag-cloud">
            
            
            <li >
                <a href="/tags/bpf"><i class="fas fa-tags"></i> bpf</a>
            </li>
            
            <li >
                <a href="/tags/ccf"><i class="fas fa-tags"></i> ccf</a>
            </li>
            
            <li >
                <a href="/tags/containers"><i class="fas fa-tags"></i> containers</a>
            </li>
            
            <li >
                <a href="/tags/cpuidle"><i class="fas fa-tags"></i> cpuidle</a>
            </li>
            
            <li >
                <a href="/tags/hao022"><i class="fas fa-tags"></i> hao022</a>
            </li>
            
            <li >
                <a href="/tags/huatuo"><i class="fas fa-tags"></i> huatuo</a>
            </li>
            
            <li >
                <a href="/tags/k8s"><i class="fas fa-tags"></i> k8s</a>
            </li>
            
            <li >
                <a href="/tags/linux-%e5%86%85%e6%a0%b8"><i class="fas fa-tags"></i> linux å†…æ ¸</a>
            </li>
            
            <li >
                <a href="/tags/loadavg"><i class="fas fa-tags"></i> loadavg</a>
            </li>
            
            <li >
                <a href="/tags/netrecvlat"><i class="fas fa-tags"></i> netrecvlat</a>
            </li>
            
            <li >
                <a href="/tags/networking"><i class="fas fa-tags"></i> networking</a>
            </li>
            
            <li >
                <a href="/tags/%e5%8f%af%e8%a7%82%e6%b5%8b%e6%80%a7"><i class="fas fa-tags"></i> å¯è§‚æµ‹æ€§</a>
            </li>
            
            <li >
                <a href="/tags/%e5%90%88%e4%bd%9c"><i class="fas fa-tags"></i> åˆä½œ</a>
            </li>
            
            <li >
                <a href="/tags/%e5%a4%9c%e8%8e%ba%e7%9b%91%e6%8e%a7"><i class="fas fa-tags"></i> å¤œèºç›‘æ§</a>
            </li>
            
            <li >
                <a href="/tags/%e5%bc%80%e6%ba%90"><i class="fas fa-tags"></i> å¼€æº</a>
            </li>
            
            <li >
                <a href="/tags/%e6%95%85%e9%9a%9c"><i class="fas fa-tags"></i> æ•…éšœ</a>
            </li>
            
            <li >
                <a href="/tags/%e7%81%ab%e7%84%b0%e5%9b%be"><i class="fas fa-tags"></i> ç«ç„°å›¾</a>
            </li>
            
            <li >
                <a href="/tags/%e7%bd%91%e7%bb%9c%e4%bc%98%e5%8c%96"><i class="fas fa-tags"></i> ç½‘ç»œä¼˜åŒ–</a>
            </li>
            
            <li >
                <a href="/tags/%e8%8d%a3%e8%aa%89"><i class="fas fa-tags"></i> è£èª‰</a>
            </li>
            
        </ul>
    </div>

</div>






                        

                    </div>
                    

                    

                </div>
                

            </div>
            
        </div>
        

        <footer id="footer">
    <div class="container">

        
        <div class="col-md-4 col-sm-6">
            <h4>å…³äºæˆ‘ä»¬</h4>

            <p>ä¸€ç¾¤å¼€æºæŠ€æœ¯çˆ±å¥½è€…ï¼ŒåŸºç¡€æŠ€æœ¯ç ”ç©¶è€…ã€‚</p>

            <hr class="hidden-md hidden-lg hidden-sm">

        </div>
        
        

        <div class="col-md-4 col-sm-6">

            

        </div>
        

        
        <div class="col-md-4 col-sm-6">

          <h4>è”ç³»</h4>

            <p class="text-uppercase"><strong>HUATUO å¼€æºæŠ€æœ¯ç¤¾åŒº, æ¬¢è¿æŠ€æœ¯äº¤æµ</strong>
        <br>ä¸­å›½åŒ—äº¬å¸‚æµ·æ·€åŒºè¥¿äºŒæ——è½¯ä»¶å›­ã€‚
        <br>
      </p>
      

	    <a href="/about" class="btn btn-small btn-template-main">è·³åˆ°è”ç³»é¡µé¢</a>

            <hr class="hidden-md hidden-lg hidden-sm">

        </div>
        
        

    </div>
    
</footer>







<div id="copyright">
    <div class="container">
        <div class="col-md-12">
            
            <p class="pull-left">(C) 2025-2026 HUATUO å¼€æºæŠ€æœ¯ç¤¾åŒº</p>
            
        </div>
    </div>
</div>





    </div>
    

    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-TVWV1CTT56"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-TVWV1CTT56');
        }
      </script>
<script src="//code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/Counter-Up/1.0/jquery.counterup.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-parallax/1.1.3/jquery-parallax.js"></script>


<script src="/js/front.js"></script>


<script src="/js/owl.carousel.min.js"></script>


  </body>
</html>
